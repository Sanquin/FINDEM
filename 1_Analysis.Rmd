---
title: "Find'em data prep & analyses"
author: "S Ramondt & A Meulenbeld"
date: "1/30/2022"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)       
library(haven)           # inporting SPSS data files
library(furniture)       # nice tables of descriptives
library(corrplot)        # visualize correlations
library(GGally)          # extensions to ggplot2
library(sjlabelled)      # work with SPSS data
library(lubridate)       # dates
library(lme4)            # mixed models
```

# Clean

```{r Read-in data, include=FALSE}
setwd("C:/Users/meule01a/OneDrive - Sanquin/A3 Project FINDEM (OD)")
data_raw <- read_sav("Donaties_3meetweken_test.sav") #using my project folder structure, adapt to yours.

```

```{r Inspect}
head(data_raw)
glimpse(data_raw)

```

```{r Select, echo=TRUE}
# check labels
data_raw$HbGoedgekeurd %>% attr('labels')

# select
data_raw2 <- data_raw %>% select(KeyID, Hb, HbGoedgekeurd, Ferritine_FINDEM, stap, Meetweek, cluster, Geslacht, Gewicht, Lengte, LeeftijdBijDOnatie)

glimpse(data_raw2)
```

```{r Recode 1: Factorize, echo=TRUE, rename, and intervention, include=FALSE}
data_clean <- data_raw2 %>% 
  mutate(Hbgood = factor(case_when(HbGoedgekeurd == 0 ~ 0, HbGoedgekeurd == 1 ~ 1))) %>% 
  mutate(Gender = factor(Geslacht) %>% fct_recode("Male" = "Man", "Female" = "Vrouw")) %>% 
  mutate(Timepoint = case_when(Meetweek == 0 ~ as.Date('2017-11-01'), Meetweek == 1 ~ as.Date('2019-03-01'), TRUE ~ as.Date('2019-11-01'))) %>% 
  mutate(Step = case_when(stap == 1.0 ~ as.Date('2017-11-01'), stap == 2.1 ~ as.Date('2018-05-01'), stap == 2.2~ as.Date('2018-10-01'), 
                          stap == 3.1 ~ as.Date('2019-03-01'), stap == 3.2 ~ as.Date('2019-10-01'), stap == 4.0 ~ as.Date('2019-11-01'))) %>% 
  mutate(Intervention_months = interval(Step, Timepoint) %/% months(1)) %>% mutate(Intervention_months =  if_else(Intervention_months < 0, 0, Intervention_months)) %>% 
  mutate(Intervention = factor(case_when(Intervention_months == 0 ~ 0, TRUE & !is.na(Intervention_months)~ 1))) %>% # just the way I created this shows how useless it is :)
  mutate(PostMeno = factor(case_when(Gender == "Female" & LeeftijdBijDOnatie < 45 ~ 0, Gender== "Female" & LeeftijdBijDOnatie >= 45 ~ 1))) %>%
  rename(Ferritin = Ferritine_FINDEM, Age = LeeftijdBijDOnatie, Cluster = cluster, Weight = Gewicht, Height = Lengte) %>% select(-HbGoedgekeurd, -Geslacht)


# check
data_clean %>% select(-Weight, -Height, -Age) %>% head()
glimpse(data_clean)
data_clean %>% select(-Weight, -Height, -Age) %>% filter(Step == '2019-11-01')

```

```{r Summary Statistics 1}
# Quick view
summary(data_clean)
```

```{r Ferritin plot gender}
data_clean %>% 
  ggplot() +
  aes(x    = Gender, 
      y    = Ferritin,
      fill = Gender) +
  geom_boxplot(alpha = 0.6) +
  scale_fill_manual(values = c("mediumblue", "maroon3")) +
  labs(x = "Gender",
       y = "Ferritin") +
  guides(fill = FALSE) +
  theme_bw()

```

```{r Hb plot gender}
data_clean %>% 
  ggplot() +
  aes(x    = Gender, 
      y    = Hb,
      fill = Gender) +
  geom_boxplot(alpha = 0.6) +
  scale_fill_manual(values = c("mediumblue", "maroon3")) +
  labs(x = "Gender",
       y = "Hb") +
  guides(fill = "none") +
  theme_bw()

# 
data_clean %>% filter(Hb == 999) 
```

**Note.** Hb 999 is missing. Ferritin might need action.

```{r Recode 2: missing, include=FALSE}
data_clean$Hb <- replace(data_clean$Hb, data_clean$Hb == 999, NA)
data_clean$Ferritin <- replace(data_clean$Ferritin, data_clean$Ferritin >= 1500, NA)

```

```{r scale variables, include=F}
data_scale <- data_clean
data_scale$Age <- scale(data_scale$Age, center=TRUE, scale = FALSE)
data_scale$Weight <- scale(data_scale$Weight, center=TRUE, scale = FALSE)
data_scale$Height <- scale(data_scale$Height, center=TRUE, scale = FALSE)
data_scale$FerritinLog <- log(data_scale$Ferritin) 
```

```{r Save, eval = FALSE, include = F}
write_spss(data_clean, "findem_clean.sav") #using my project folder structure, adapt to yours.
write_spss(data_scale, "findem_scale.sav")
```

# Explore

```{r Summary Statistics 2}
# Quick view
summary(data_clean)
```

```{r Table 1}
# Intevention yes/no
data_clean %>% 
  select(-KeyID,-stap, -Meetweek, -Cluster, -Ferritin, -Timepoint, -Step) %>% 
  group_by(Intervention) %>% 
  table1(output = "markdown",
         total = TRUE)

```

```{r Quick & Dirty Exploring Data, eval = FALSE}
data_clean %>%
  na.omit() %>% 
  select(-KeyID, -stap, -Meetweek, -Cluster, -Hbgood, -Timepoint, -Step, -Weight, -Height, -Intervention_months) %>%
  GGally::ggpairs(mapping = aes(fill    = Intervention,
                              col       = Intervention,
                              alpha     = 0.05),
                upper = list(continuous = "smooth",
                             combo      = "facethist",
                             discrete   = "ratio"),
                lower = list(continuous = "cor",
                             combo      = "box",
                             discrete   = "facetbar"),
                title = "Quick & Dirty Exploring Data") 
```

```{r Correlation plot}
data_clean %>% 
  na.omit() %>% 
  select(-KeyID, -stap, -Meetweek, -Cluster,-Timepoint, -Step, -Hbgood) %>%
  mutate(Gender = as.numeric(Gender), Intervention = as.numeric(Intervention)) %>%
  rename(Int = Intervention, Months = Intervention_months) %>% 
  cor() %>% 
  corrplot.mixed(lower  = "ellipse",
                           upper  = "number",
                           tl.col = "black")
```

#Analysis
```{r read in data for analysis}
data_scale <- read_sav("findem_scale.sav")
```

```{r hb females}
hb_fitF <- lm(Hb ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Female")
hb_fitFfactor <- lm(Hb ~ Age + Weight + Height + as.factor(Intervention_months), data = data_scale, subset = data_scale$Gender == "Female")

hb_fit_preF_factor <- update(hb_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
hb_fit_postF_factor <- update(hb_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)
```

```{r hb males}
hb_fitM <- lm(Hb ~ Age + Weight + Height + Intervention_months , data = data_scale, subset = data_scale$Gender == "Male")
hb_fitMfactor <- lm(Hb ~ Age + Weight + Height + as.factor(Intervention_months), data = data_scale, subset = data_scale$Gender == "Male")
```

```{r hb deferral females}

hbdef_fitF <- glm(formula = Hbgood ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Female" ,family = binomial)
hbdef_fitFfactor <- update(hbdef_fitF, formula = Hbgood ~ Age + Weight + Height + as.factor(Intervention_months))
hbdef_fit_postF_factor <- update(hbdef_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)
hbdef_fit_preF_factor <- update(hbdef_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
``` 

**Note** Get an error for females because the model couldn't converge, we then scaled variables. After this we decided to use scaled variables in all models.

```{r hb deferral males}
hbdef_fitM <- glm(formula = Hbgood ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male" ,family = binomial)

hbdef_fitMfactor <- update(hbdef_fitM, formula = Hbgood ~ Age + Weight + Height + as.factor(Intervention_months))

```

**Note 4** based on singularity issues and ICCs of nearly 0 (see chunck at end) we decided to use OLS models instead of mixed models.

```{r ferritin females}
ferr_fitF <- lm(Ferritin ~ Age + Weight + Height + Intervention_months , data = data_scale, subset = data_scale$Gender == "Female")
ferr_fitFfactor <- update(ferr_fitF, formula = Ferritin ~ Age + Weight + Height + as.factor(Intervention_months))
ferr_fit_preF_factor <- update(ferr_fitFfactor, subset  = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
ferr_fit_postF_factor <- update(ferr_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)

#log transformed
ferrlog_fitF <- lm(FerritinLog ~ Age + Weight + Height + Intervention_months , data = data_scale, subset = data_scale$Gender == "Female")
ferrlog_fitFfactor <- update(ferrlog_fitF, formula = FerritinLog ~ Age + Weight + Height + as.factor(Intervention_months))
ferrlog_fit_preF_factor <- update(ferrlog_fitFfactor, subset  = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
ferrlog_fit_postF_factor <- update(ferrlog_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)
```

```{r ferritin males}
ferr_fitM <- lm(Ferritin ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male")
ferr_fitMfactor <- update(ferr_fitM, formula = Ferritin ~ Age + Weight + Height + as.factor(Intervention_months))

#log transformed
ferrlog_fitM <- lm(FerritinLog ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male")
ferrlog_fitMfactor <- update(ferrlog_fitM, formula = FerritinLog ~ Age + Weight + Height + as.factor(Intervention_months))
```

**Note** Added a code to have a bit better readable tables, but feel free to remove them

```{r nicer tables}
library(sjPlot)

pl <- c(
  `(Intercept)` = "Intercept",
  `as.factor(Intervention_months)1` = "1 month",
  `as.factor(Intervention_months)5` = "5 months",
  `as.factor(Intervention_months)8` = "8 months",
  `as.factor(Intervention_months)10` = "10 months",
  `as.factor(Intervention_months)13` = "13 months",
  `as.factor(Intervention_months)16` = "16 months",
  `as.factor(Intervention_months)18` = "18 months",
  `as.factor(Intervention_months)24` = "24 months"
)

currentDate <- format(Sys.time(), "%Y-%m-%d")
FolderName <- paste("HTML tables/", currentDate,sep="")
dir.create(FolderName)


FileName <- paste("HTML tables/", currentDate, "/hb_fit.html",sep="")
tab_model(hb_fit_preF_factor, hb_fit_postF_factor, hb_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), show.reflvl = T, title = "Hb levels")

FileName <- paste("HTML tables/", currentDate, "/hbdef_fit.html",sep="")
tab_model(hbdef_fit_preF_factor, hbdef_fit_postF_factor, hbdef_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Hb deferral", show.reflvl = T)

FileName <- paste("HTML tables/", currentDate, "/ferr_fit.html",sep="")
tab_model(ferr_fit_preF_factor, ferr_fit_postF_factor, ferr_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Ferritin levels", show.reflvl = T)

FileName <- paste("HTML tables/", currentDate, "/ferrlog_fit.html",sep="")
tab_model(ferrlog_fit_preF_factor, ferrlog_fit_postF_factor, ferrlog_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Log transformed ferritin levels", show.reflvl = T)

```