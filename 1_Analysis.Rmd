---
title: "Find'em data prep & analyses"
author: "S Ramondt & A Meulenbeld"
date: "1/30/2022"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)       
library(haven)           # inporting SPSS data files
library(furniture)       # nice tables of descriptives
library(corrplot)        # visualize correlations
library(GGally)          # extensions to ggplot2
library(sjlabelled)      # work with SPSS data
library(lubridate)       # dates
library(lme4)            # mixed models
library(car)             # assumptions: vif
```

# Clean

```{r Read-in data, include=FALSE}
setwd("C:/Users/meule01a/OneDrive - Sanquin/A3 Project FINDEM (OD)")
oud <- read_sav("C:/Users/meule01a/OneDrive - Sanquin/A3 Project FINDEM (OD)/01 Data/Donaties_3meetweken_test.sav")
data_raw <- read_sav("C:/Users/meule01a/OneDrive - Sanquin/A3 Project FINDEM (OD)/01 Data/Donaties_4meetweken_plus.sav") #using my project folder structure, adapt to yours.

```

```{r Inspect}
head(data_raw)
glimpse(data_raw)

```

```{r Select, echo=TRUE}
# check labels
data_raw$HbGoedgekeurd %>% attr('labels')

# select
data_raw2 <- data_raw %>% select(KeyID, Hb, HbGoedgekeurd, Ferritine_FINDEM, stap, Meetweek, cluster, Geslacht, Gewicht, Lengte, LeeftijdBijDOnatie, ReturnOpTijd, Return, Donatiedatum)

glimpse(data_raw2)
```
**Note 30-03-2022 Amber: I added the variable Intervention_months2 that we can use to add months 1 and 5 to the control group, then I added another variable Intervention_months_factor that has the 6 month groups **
```{r Recode 1: Factorize, echo=TRUE, rename, and intervention, include=FALSE}
data_clean <- data_raw2 %>% 
  mutate(HbDef = factor(case_when(HbGoedgekeurd == 0 ~ 1, HbGoedgekeurd == 1 ~ 0))) %>% 
  mutate(Gender = factor(Geslacht) %>% fct_recode("Male" = "Man", "Female" = "Vrouw")) %>% 
  mutate(Timepoint = case_when(Meetweek == 0 ~ as.Date('2017-11-01'), Meetweek == 1 ~ as.Date('2019-03-01'), Meetweek == 2 ~ as.Date('2019-11-01'), TRUE ~ as.Date('2020-11-23'))) %>% 
  mutate(Step = case_when(stap == 1.0 ~ as.Date('2017-11-01'), stap == 2.1 ~ as.Date('2018-05-01'), stap == 2.2~ as.Date('2018-10-01'), 
                          stap == 3.1 ~ as.Date('2019-03-01'), stap == 3.2 ~ as.Date('2019-10-01'), stap == 4.0 ~ as.Date('2019-11-01'))) %>% 
  mutate(Intervention_months = interval(Step, Timepoint) %/% months(1)) %>% mutate(Intervention_months =  if_else(Intervention_months < 0, 0, Intervention_months)) %>% 
  mutate(Intervention = factor(case_when(Intervention_months == 0 ~ 0, TRUE & !is.na(Intervention_months)~ 1))) %>% # just the way I created this shows how useless it is :)
  mutate(PostMeno = factor(case_when(Gender == "Female" & LeeftijdBijDOnatie < 45 ~ 0, Gender== "Female" & LeeftijdBijDOnatie >= 45 ~ 1))) %>%
  rename(Ferritin = Ferritine_FINDEM, Age = LeeftijdBijDOnatie, Cluster = cluster, Weight = Gewicht, Height = Lengte)  %>% mutate(IronDef = factor(case_when(Ferritin >= 15 ~ 0, Ferritin < 15 ~ 1)))%>% 
  select(-HbGoedgekeurd, -Geslacht)%>%
  mutate(Intervention_months2 =  if_else(Intervention_months < 6, 0, Intervention_months))%>%
  mutate(Intervention_months_factor = factor(case_when(Intervention_months == 0 ~ 0, Intervention_months == 1 ~ 0, Intervention_months == 5 ~ 0, Intervention_months == 8 ~ 1, Intervention_months == 10 ~ 1, Intervention_months == 12 ~ 2, Intervention_months == 13 ~ 2,Intervention_months == 16 ~ 2,Intervention_months == 18 ~ 3, Intervention_months == 20 ~ 3, Intervention_months == 24 ~ 4, Intervention_months == 25 ~ 4, Intervention_months == 30 ~ 5, Intervention_months == 36 ~ 6))) %>%
  mutate(COVID = factor(case_when(Donatiedatum < "2019-10-01" ~ 0, Donatiedatum >= "2019-10-01" ~ 1)))#%>%
  #mutate(Intervention_months_factor=fct_relevel(Intervention_months_factor, c("0-5 months", "6-11 months", "12-17 months", "18-23 months", "24-29 months", "30-35 months", "36+ months")))


# check
data_clean %>% select(-Weight, -Height, -Age) %>% head()
glimpse(data_clean)
data_clean %>% select(-Weight, -Height, -Age) %>% filter(Step == '2019-11-01')

```

```{r Summary Statistics 1}
# Quick view
summary(data_clean)
```

**Note.** Ferritin missing data is expected. Cluster missing data is problematic. Hb max of 999, Ferritin of 2000, is that possible? 504 not tested if HB is good.

```{r Ferritin plot gender}
data_clean %>% 
  ggplot() +
  aes(x    = Gender, 
      y    = Ferritin,
      fill = Gender) +
  geom_boxplot(alpha = 0.6) +
  scale_fill_manual(values = c("mediumblue", "maroon3")) +
  labs(x = "Gender",
       y = "Ferritin") +
  guides(fill = FALSE) +
  theme_bw()

```

```{r Hb plot gender}
data_clean %>% 
  ggplot() +
  aes(x    = Gender, 
      y    = Hb,
      fill = Gender) +
  geom_boxplot(alpha = 0.6) +
  scale_fill_manual(values = c("mediumblue", "maroon3")) +
  labs(x = "Gender",
       y = "Hb") +
  guides(fill = "none") +
  theme_bw()

# 
data_clean %>% filter(Hb == 999) 
```

**Note.** Hb 999 is missing. Ferritin might need action.

```{r Recode 2: missing, include=FALSE}
data_clean$Hb <- replace(data_clean$Hb, data_clean$Hb == 999, NA)
data_clean$Ferritin <- replace(data_clean$Ferritin, data_clean$Ferritin >= 1500, NA)

```

```{r scale variables, include=F}
data_scale <- data_clean
data_scale$Age <- scale(data_scale$Age, center=TRUE, scale = FALSE)
data_scale$Weight <- scale(data_scale$Weight, center=TRUE, scale = FALSE)
data_scale$Height <- scale(data_scale$Height, center=TRUE, scale = FALSE)
data_scale$FerritinLog <- log(data_scale$Ferritin) 
```

```{r Save, eval = FALSE, include = F}
#write_spss(data_clean, "findem_clean.sav") #using my project folder structure, adapt to yours.
#write_spss(data_scale, "findem_scale.sav")

save(data_clean, file = "findem_clean.Rdta")
save(data_scale, file = "findem_scale.Rdta")
```

# Explore

```{r Summary Statistics 2}
# Quick view
summary(data_clean)
```

```{r Table 1}
# Intevention yes/no
data_clean %>% 
  select(-KeyID,-stap, -Meetweek, -Cluster, -Ferritin, -Timepoint, -Step) %>% 
  group_by(Intervention) %>% 
  table1(output = "markdown",
         total = TRUE)

```

```{r Quick & Dirty Exploring Data, eval = FALSE}
data_clean %>%
  na.omit() %>% 
  select(-KeyID, -stap, -Meetweek, -Cluster, -Hbgood, -Timepoint, -Step, -Weight, -Height, -Intervention_months, -Ferritingood) %>%
  GGally::ggpairs(mapping = aes(fill    = Intervention,
                              col       = Intervention,
                              alpha     = 0.05),
                upper = list(continuous = "smooth",
                             combo      = "facethist",
                             discrete   = "ratio"),
                lower = list(continuous = "cor",
                             combo      = "box",
                             discrete   = "facetbar"),
                title = "Quick & Dirty Exploring Data") 
```

```{r Correlation plot}
data_clean %>% 
  na.omit() %>% 
  select(-KeyID, -stap, -Meetweek, -Cluster,-Timepoint, -Step, -Hbgood, -Ferritingood) %>%
  mutate(Gender = as.numeric(Gender), Intervention = as.numeric(Intervention)) %>%
  rename(Int = Intervention, Months = Intervention_months) %>% 
  cor() %>% 
  corrplot.mixed(lower  = "ellipse",
                           upper  = "number",
                           tl.col = "black")
```

#Analysis
```{r read in data for analysis}
load("findem_scale.Rdta")
```

**Note 30-03-2022 Amber: I adjusted the analyses to now use the intervention_months_factor i.e. the 6 month groups**

```{r hb females}
hb_fitF <- lm(Hb ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Female")
hb_fitFfactor <- lm(Hb ~ Age + Weight + Height + Intervention_months_factor, data = data_scale, subset = data_scale$Gender == "Female")

hb_fit_preF_factor <- update(hb_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
hb_fit_postF_factor <- update(hb_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)
```

```{r hb males}
hb_fitM <- lm(Hb ~ Age + Weight + Height + Intervention_months , data = data_scale, subset = data_scale$Gender == "Male")
hb_fitMfactor <- lm(Hb ~ Age + Weight + Height + Intervention_months_factor, data = data_scale, subset = data_scale$Gender == "Male")
```

```{r hb deferral females}

hbdef_fitF <- glm(formula = HbDef ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Female" ,family = binomial)
hbdef_fitFfactor <- update(hbdef_fitF, formula = HbDef ~ Age + Weight + Height + Intervention_months_factor)
hbdef_fit_postF_factor <- update(hbdef_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)
hbdef_fit_preF_factor <- update(hbdef_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
``` 

**Note** Get an error for females because the model couldn't converge, we then scaled variables. After this we decided to use scaled variables in all models.

```{r hb deferral males}
hbdef_fitM <- glm(formula = HbDef ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male" ,family = binomial)

hbdef_fitMfactor <- update(hbdef_fitM, formula = HbDef ~ Age + Weight + Height + Intervention_months_factor)

```

**Note 4** based on singularity issues and ICCs of nearly 0 (see chunk at end) we decided to use OLS models instead of mixed models.

```{r ferritin females}
ferr_fitF <- lm(Ferritin ~ Age + Weight + Height + Intervention_months , data = data_scale, subset = data_scale$Gender == "Female")
ferr_fitFfactor <- update(ferr_fitF, formula = Ferritin ~ Age + Weight + Height + Intervention_months_factor)
ferr_fit_preF_factor <- update(ferr_fitFfactor, subset  = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
ferr_fit_postF_factor <- update(ferr_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)

#log transformed
ferrlog_fitF <- lm(FerritinLog ~ Age + Weight + Height + Intervention_months , data = data_scale, subset = data_scale$Gender == "Female")
ferrlog_fitFfactor <- update(ferrlog_fitF, formula = FerritinLog ~ Age + Weight + Height + Intervention_months_factor)
ferrlog_fit_preF_factor <- update(ferrlog_fitFfactor, subset  = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
ferrlog_fit_postF_factor <- update(ferrlog_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)
```

```{r ferritin males}
ferr_fitM <- lm(Ferritin ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male")
ferr_fitMfactor <- update(ferr_fitM, formula = Ferritin ~ Age + Weight + Height + Intervention_months_factor)

#log transformed
ferrlog_fitM <- lm(FerritinLog ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male")
ferrlog_fitMfactor <- update(ferrlog_fitM, formula = FerritinLog ~ Age + Weight + Height + Intervention_months_factor)
```

```{r iron deficiency females}
irondef_fitF <- glm(formula = IronDef ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Female",family = binomial)

irondef_fitFfactor <- update(irondef_fitF, formula = IronDef ~ Age + Weight + Height + Intervention_months_factor)
irondef_fit_preF_factor <- update(irondef_fitF, formula = IronDef ~ Age + Weight + Height + Intervention_months_factor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
irondef_fit_postF_factor <- update(irondef_fitF, formula = IronDef ~ Age + Weight + Height + Intervention_months_factor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)

```

```{r ferritin good males}
irondef_fitM <- glm(formula = IronDef ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male",family = binomial)

irondef_fitMfactor <- update(irondef_fitM, formula = IronDef ~ Age + Weight + Height + Intervention_months_factor)

```

**Note** we still need to add the analysis for the donor return, i'm in doubt whether we need to analyse it using logistic regression or with survival analysis?
```{r donor return females}

return_fitF <- glm(formula = Return ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Female" ,family = binomial)
return_fitFfactor <- update(hbdef_fitF, formula = Return ~ Age + Weight + Height + Intervention_months_factor)
return_fit_postF_factor <- update(return_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)
return_fit_preF_factor <- update(return_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
```

```{r return males}
return_fitM <- glm(formula = Return ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male",family = binomial)

return_fitMfactor <- update(return_fitM, formula = Return ~ Age + Weight + Height + Intervention_months_factor)
```

```{r returnOpTijd females}

returnOT_fitF <- glm(formula = ReturnOpTijd ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Female" ,family = binomial)

returnOT_fitFfactor <- update(returnOT_fitF, formula = ReturnOpTijd ~ Age + Weight + Height + Intervention_months_factor)

returnOT_fit_postF_factor <- update(returnOT_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 1)
returnOT_fit_postF_factor_notdeferred<-update(returnOT_fit_postF_factor, subset = data_scale$Gender=="Female" & data_scale$PostMeno == 1 & data_scale$Ferritin > 30)
returnOT_fit_postF_factor_deferred<-update(returnOT_fit_postF_factor, subset = data_scale$Gender=="Female" & data_scale$PostMeno == 1 & data_scale$Ferritin <= 30)

returnOT_fit_postF_factor_COVID<-update(returnOT_fit_postF_factor, subset = data_scale$Gender=="Female" & data_scale$PostMeno == 1 & data_scale$COVID ==1)
returnOT_fit_postF_factor_notCOVID<-update(returnOT_fit_postF_factor, subset = data_scale$Gender=="Female" & data_scale$PostMeno == 1 & data_scale$COVID == 0)

returnOT_fit_preF_factor <- update(returnOT_fitFfactor, subset = data_scale$Gender == "Female" & data_scale$PostMeno == 0)
returnOT_fit_preF_factor_notdeferred<-update(returnOT_fit_preF_factor, subset = data_scale$Gender=="Female" & data_scale$PostMeno==0 & data_scale$Ferritin>30)
returnOT_fit_preF_factor_deferred<-update(returnOT_fit_preF_factor, subset = data_scale$Gender=="Female" & data_scale$PostMeno==0 & data_scale$Ferritin<=30)

returnOT_fit_preF_factor_COVID<-update(returnOT_fit_preF_factor, subset = data_scale$Gender=="Female" & data_scale$PostMeno==0 & data_scale$COVID==1)
returnOT_fit_preF_factor_notCOVID<-update(returnOT_fit_preF_factor, subset = data_scale$Gender=="Female" & data_scale$PostMeno==0 & data_scale$COVID==0)
```

```{r returnOpTijd males}
returnOT_fitM <- glm(formula = ReturnOpTijd ~ Age + Weight + Height + Intervention_months, data = data_scale, subset = data_scale$Gender == "Male",family = binomial)

returnOT_fitMfactor <- update(returnOT_fitM, formula = ReturnOpTijd ~ Age + Weight + Height + Intervention_months_factor)

returnOT_fitMfactor_notdeferred <- update(returnOT_fitMfactor, subset = data_scale$Gender == "Male" & data_scale$Ferritin > 30)
returnOT_fitMfactor_deferred <- update(returnOT_fitMfactor, subset = data_scale$Gender == "Male" & data_scale$Ferritin <= 30)

returnOT_fitMfactor_COVID <- update(returnOT_fitMfactor, subset = data_scale$Gender == "Male" & data_scale$COVID == 1)
returnOT_fitMfactor_notCOVID <- update(returnOT_fitMfactor, subset = data_scale$Gender == "Male" & data_scale$COVID == 0)
```
**Note** Added a code to have a bit better readable tables, but feel free to remove them

**Note2** Love it!

```{r nicer tables}
library(sjPlot)

pl <- c(
  `(Intercept)` = "Intercept",
  Intervention_months_factor1 = "6-11 months",
  Intervention_months_factor2 = "12-17 months",
  Intervention_months_factor3 = "18-23 months",
  Intervention_months_factor4 = "24-29 months",
  Intervention_months_factor5 = "30-35 months",
  Intervention_months_factor6 = "36+ months"
)

currentDate <- format(Sys.time(), "%Y-%m-%d")
FolderName <- paste("C:/Users/meule01a/OneDrive - Sanquin/A3 Project FINDEM (OD)/07 Resultaten/HTML tables/", currentDate,sep="")
dir.create(FolderName)

FileName <- paste("HTML tables/", currentDate, "/hb_fit.html",sep="")
tab_model(hb_fit_preF_factor, hb_fit_postF_factor, hb_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), show.reflvl = T, title = "Hb levels")

FileName <- paste("HTML tables/", currentDate, "/hbdef_fit.html",sep="")
tab_model(hbdef_fit_preF_factor, hbdef_fit_postF_factor, hbdef_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Hb deferral", show.reflvl = T)

FileName <- paste("HTML tables/", currentDate, "/ferr_fit.html",sep="")
tab_model(ferr_fit_preF_factor, ferr_fit_postF_factor, ferr_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Ferritin levels", show.reflvl = T)

FileName <- paste("HTML tables/", currentDate, "/ferrlog_fit.html",sep="")
tab_model(ferrlog_fit_preF_factor, ferrlog_fit_postF_factor, ferrlog_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Log transformed ferritin levels", show.reflvl = T)

FileName <- paste("HTML tables/", currentDate, "/irondef_fit.html",sep="")
tab_model(irondef_fit_preF_factor, irondef_fit_postF_factor, irondef_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Ferritin levels above 15", show.reflvl = T)

FileName <- paste("HTML tables/", currentDate, "/return_fit.html",sep="")
tab_model(return_fit_preF_factor, return_fit_postF_factor, return_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Donor return", show.reflvl = T)

FileName <- paste("HTML tables/", currentDate, "/returnOT_fit.html",sep="")
tab_model(returnOT_fit_preF_factor, returnOT_fit_postF_factor, returnOT_fitMfactor, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women", "Post-menopausal women", "Men"), title = "Donor return (on time)", show.reflvl = T)

FileName <- paste("HTML tables/", currentDate, "/returnOT_fit_deferral.html",sep="")
tab_model(returnOT_fit_preF_factor_notdeferred, returnOT_fit_preF_factor_deferred, returnOT_fit_postF_factor_notdeferred, returnOT_fit_postF_factor_deferred, returnOT_fitMfactor_notdeferred, returnOT_fitMfactor_deferred, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women NDef", "Pre-menopausal women Def", "Post-menopausal women NDef", "Post-menopausal women Def", "Men NDef", "Men Def"), title = "Donor return (on time)", show.reflvl = T)

FileName <- paste("C:/Users/meule01a/OneDrive - Sanquin/A3 Project FINDEM (OD)/07 Resultaten/HTML tables/", currentDate, "/returnOT_fit_COVID.html",sep="")
tab_model(returnOT_fit_preF_factor_notCOVID, returnOT_fit_preF_factor_COVID, returnOT_fit_postF_factor_notCOVID, returnOT_fit_postF_factor_COVID, returnOT_fitMfactor_notCOVID, returnOT_fitMfactor_COVID, file = FileName, pred.labels = pl, dv.labels = c("Pre-menopausal women NCov", "Pre-menopausal women Cov", "Post-menopausal women NCov", "Post-menopausal women Cov", "Men NCov", "Men COV"), title = "Donor return (on time)", show.reflvl = T)
```

```{r plots assumptions hb}
#hb
par(mfrow = c(2, 2))
plot(hb_fit_preF_factor)
plot(hb_fit_postF_factor)
plot(hb_fitMfactor)
```

```{r plots assumptions ferritin}
par(mfrow = c(2, 2))
plot(ferr_fit_preF_factor)
plot(ferr_fit_postF_factor)
plot(ferr_fitMfactor)
```

```{r plots assumptions log ferritin}
par(mfrow = c(2, 2))
plot(ferrlog_fit_preF_factor)
plot(ferrlog_fit_postF_factor)
plot(ferrlog_fitMfactor)

#i think the difference between this and the previous block (especially the qq plots) shows why it's better to use log ferritin than normal ferritin as an outcome
```

```{r assumptions hb deferral}
#independent observations: i guess yes?

#influential observations:
plot(hbdef_fit_preF_factor, which = 4) #this one has one quite curious observation so i want to look at the standardized residual
model.data <- augment(hbdef_fit_preF_factor) %>% 
  mutate(index = 1:n()) 
model.data %>% top_n(3, .cooksd) #the absolute standardized residual is not above 3 so we don't have to worry about this outlier.

plot(hbdef_fit_postF_factor, which = 4)
plot(hbdef_fitMfactor, which = 4)

#no multicollinearity: 

vif(hbdef_fit_preF_factor)
vif(hbdef_fit_postF_factor)
vif(hbdef_fitMfactor)
#vif is not above 4 for any of the covariates

```

```{r assumptions good ferritin}
#independent observations: i guess yes?

#influential observations:
plot(ferrgood_fit_preF_factor, which = 4) 
plot(ferrgood_fit_postF_factor, which = 4)
plot(ferrgood_fitMfactor, which = 4)

#no multicollinearity: 

vif(ferrgood_fit_preF_factor)
vif(ferrgood_fit_postF_factor)
vif(ferrgood_fitMfactor)

#vif is not above 4 for any of the covariates

```